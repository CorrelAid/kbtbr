---
title: "Survey Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
```




Page 1
=====================================  
    
Column {data-width=350}
-------------------------------------



```{r, echo=FALSE, warning=FALSE, include=FALSE}
devtools::load_all()

# Dependencies
library(kbtbr)
library(tidyr)
library(stringr)
library(dplyr)
library(shiny)
library(janitor)
library(ggplot2)
library(plotly)


# Initialize new Kobo class
BASE_URL <- "https://kobo.correlaid.org"

kobo <-
  Kobo$new(base_url_v2 = BASE_URL,
           kobo_token = Sys.getenv("KBTBR_TOKEN"))
vcr::use_cassette("kobo-asset-submissions-data", {
  submissions_df <- kobo$get_submissions("aRo4wg5utWT7dwdnQQEAE7")
})

kobo <-
  Kobo$new(base_url_v2 = BASE_URL,
           kobo_token = Sys.getenv("KBTBR_TOKEN"))
asset_id <- "aRo4wg5utWT7dwdnQQEAE7"
submissions_df <- kobo$get_submissions(asset_id)


# Data cleaning
submissions_df <- submissions_df %>%
  select(starts_with("_"), start, end, everything())

submissions_df <- submissions_df %>%
  select(
    starts_with("_"),
    start,
    end,
    Taking_all_things_to_ould_you_say_you_are,
    starts_with("importance_in_life"),
    trust_in_others,
    starts_with("trust_in_groups"),
    control_over_life,
    voluntary_activity,
    locate_hamburg,
    health_self_assessment,
    file_upload
  )


renamed_meta <- submissions_df %>%
  rename_with(make_clean_names, starts_with("_"))

renamed_except_rating <- submissions_df %>%
  rename_with(make_clean_names,-starts_with(c("importance_in_life", "trust_in_groups")))

submissions_df <- renamed_except_rating

submissions_df <- submissions_df %>%
  mutate(across(c(starts_with(
    c("importance_in_life", "trust_in_groups")
  ),
  any_of(
    c(
      "voluntary_activity",
      "control_over_life",
      "health_self_assessment",
      "trust_in_others",
      "Taking_all_things_to_ould_you_say_you_are"
    )
  )), as.integer))


new_column_names <-
  paste("locate_hamburg", c("lat", "lon", "altitude", "accuracy"), sep = "_")

# use separate to split the column into four columns
# submissions_df <- submissions_df %>%
#   separate(locate_hamburg, new_column_names, sep = " ") %>%
#   mutate(across(starts_with("locate_hamburg"), as.numeric)) # convert to double


# Helper function to put tibble in appropriate format
pivot_longer_rating <- function(data, question_name) {
  data %>%
    select(id, starts_with(question_name)) %>%
    pivot_longer(-id, names_to = "category", values_to = "level") %>%
    mutate(category = str_remove(category, paste0(question_name, "/")) %>% str_replace_all("_", " "))
}


```

### Q1

```{r, echo=FALSE, warning=FALSE}
p1 <- submissions_df %>% 
  pivot_longer_rating("importance_in_life") %>% 
  group_by(category) %>%
  summarize(mean_level = mean(level)) %>% 
  ggplot(aes(x = category, y = round(mean_level, 2))) +
  theme_classic() +
  geom_col(fill = "lightsteelblue3") +
  coord_flip() +
  xlab("") + 
  ggtitle("Mean importance in life by category") +
  labs(y = "mean importance") +
  scale_x_discrete(labels = 
                     function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 15))

ggplotly(p1)
  
```






Column {data-width=350}
-----------------------------------------------------------------------

### Q2

```{r}
p2 <- submissions_df %>% 
  pivot_longer_rating("trust_in_groups") %>% 
  group_by(category) %>%
  summarize(mean_level = mean(level)) %>% 
  ggplot(aes(x = category, y = round(mean_level, 2))) +
  theme_classic() +
  geom_col(fill = "lightsteelblue3") +
  coord_flip() +
  xlab("") + 
  ggtitle("Trust in groups by category") +
  labs(y = "mean trust") +
  scale_x_discrete(labels = 
                     function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 15))

ggplotly(p2)
  
```


Page 2
===================================== 

```{r, echo=FALSE}
#geo_location <- na.omit(submissions$results$Please_indicate_wher_the_map_is_Hamburg)[1:3] 
```



